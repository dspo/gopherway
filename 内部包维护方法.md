# 内部包维护方法
内部包维护指的是, 开发过程中常用的代码和包, 应当组织起来, 提高复用程度.  
目前代码复用存在的问题, 主要在于常用包分散于各个具体的项目中, 不利于集中维护.  
如, 阅兵保障项目中开发的/utils包, 可以复用在b2c项目中, 
目前的做法是手动从阅兵保障项目中拷贝/utils包到b2c项目中.  
在两个项目分别开发过程中, 其中一个项目/utils包的修改, 不能同步到另一个项目中, 
当要维护的项目过多时, /utils包的不一致必定越来越多, 而且维护人员也难以区分哪个/utils包中的代码更新, 
哪个包中的代码更稳定, 哪个包中的代码更丰富更齐全了.  
所以将/utils这样的复用率较高的包单独拎出来维护是有必要的.  


有三种维护方案:  
* 第一种, 使用内网svn  
使用内网svn能一定程度上提高共同维护的效率, 但是我们的生产项目也是使用svn进行版本管理, 
当/utils包更新后, 还有单独用svn拉取下来, 放在生产项目的具体目录里.  

* 第二种, 使用外网github, gitlab等  
使用外网github, gitlab首先不符合公司保密要求, `go get`配置私有库也过于麻烦.  

* 第三中, 使用内网gitlab
一个gitlab平台已经搭建在http://192.168.1.195:8011, 可以进行代码管理.  
并且已经上传了一个示例项目http://192.168.1.195:8011/chenzhongrun/utils  
我们需要做的, 是令`go get`命令支持我们的内网平台.  
由于Go原生只支持github, gitlab, gitee等平台, 所以我们需要简单修改Go的源码,
以支持我们搭建的内网平台.  

## 修改Go源码以支持内网git平台
要使`go get`支持内网平台, 只需修改`$GOROOT$\src\cmd\go\internal\get\vcs.go`文件, 
文件970行(不同版本略有差异, 寻找代码具体位置可以搜索)以下有如下代码:  
```go
// vcsPaths defines the meaning of import paths referring to
// commonly-used VCS hosting sites (github.com/user/dir)
// and import paths referring to a fully-qualified importPath
// containing a VCS type (foo.com/repo.git/dir)
var vcsPaths = []*vcsPath{
	// Github
	{
		prefix: "github.com/",
		re:     `^(?P<root>github\.com/[A-Za-z0-9_.\-]+/[A-Za-z0-9_.\-]+)(/[\p{L}0-9_.\-]+)*$`,
		vcs:    "git",
		repo:   "https://{root}",
		check:  noVCSSuffix,
	},

	// Bitbucket
	{
		prefix: "bitbucket.org/",
		re:     `^(?P<root>bitbucket\.org/(?P<bitname>[A-Za-z0-9_.\-]+/[A-Za-z0-9_.\-]+))(/[A-Za-z0-9_.\-]+)*$`,
		repo:   "https://{root}",
		check:  bitbucketVCS,
	},

	// IBM DevOps Services (JazzHub)
	{
		prefix: "hub.jazz.net/git/",
		re:     `^(?P<root>hub\.jazz\.net/git/[a-z0-9]+/[A-Za-z0-9_.\-]+)(/[A-Za-z0-9_.\-]+)*$`,
		vcs:    "git",
		repo:   "https://{root}",
		check:  noVCSSuffix,
	},

	// Git at Apache
	{
		prefix: "git.apache.org/",
		re:     `^(?P<root>git\.apache\.org/[a-z0-9_.\-]+\.git)(/[A-Za-z0-9_.\-]+)*$`,
		vcs:    "git",
		repo:   "https://{root}",
	},

	// Git at OpenStack
	{
		prefix: "git.openstack.org/",
		re:     `^(?P<root>git\.openstack\.org/[A-Za-z0-9_.\-]+/[A-Za-z0-9_.\-]+)(\.git)?(/[A-Za-z0-9_.\-]+)*$`,
		vcs:    "git",
		repo:   "https://{root}",
	},

	// chiselapp.com for fossil
	{
		prefix: "chiselapp.com/",
		re:     `^(?P<root>chiselapp\.com/user/[A-Za-z0-9]+/repository/[A-Za-z0-9_.\-]+)$`,
		vcs:    "fossil",
		repo:   "https://{root}",
	},

	// General syntax for any server.
	// Must be last.
	{
		re:   `^(?P<root>(?P<repo>([a-z0-9.\-]+\.)+[a-z0-9.\-]+(:[0-9]+)?(/~?[A-Za-z0-9_.\-]+)+?)\.(?P<vcs>bzr|fossil|git|hg|svn))(/~?[A-Za-z0-9_.\-]+)*$`,
		ping: true,
	},

	// golang.helowin.com 此处增加
	{
		prefix: "golang.helowin.com/",
		re:     `^(?P<root>golang\.helowin\.com/(?P<p>[A-Za-z0-9_.\-]+/[A-Za-z0-9_.\-]+))(/[A-Za-z0-9_.\-]+)*$`,
		vcs:    "git",
		repo:   "http://192.168.1.195:8011/{p}",
		ping:false,
		check:  noVCSSuffix,
	},
}
```   
可以看到, `vcsPaths`变量维护了`go get`所支持的站点和平台, 我们在最后增加了对`golang.helowin.com`
的支持.  将`golang.helowin.com/{path}`的包指向`http://192.168.1.195:8011/{p}`.  

另外还需修改一个函数, 这个函数检查前缀和路径的合法性. 由于我们没有域名, 路径以`{IP}:{Port}{Path}`
形式组成, 无法通过检查, 所以需要略作修改.  
```go
// pathPrefix reports whether sub is a prefix of s,
// only considering entire path components.
func pathPrefix(s, sub string) bool {
	// strings.HasPrefix is necessary but not sufficient.
	if !strings.HasPrefix(s, sub) {
		return false
	}
	// The remainder after the prefix must either be empty or start with a slash.
	rem := s[len(sub):]
    // return rem == "" || rem[0] == '/' ||
	return rem == "" || rem[0] == '/' || rem[0] == ':'//此处修改
}
```  

修改完成之后, 需要重新编译go.exe可执行文件.  
```cmd
$GOROOT$\src\cmd\go>> go install
```

## 用`go get`安装内网gitlab平台上的包
### 安装
在我们的项目中打开命令行窗口, 
```cmd
>>go get -v -u -insecure golang.helowin.com/go-gateway/utils

  go: finding golang.helowin.com/go-gateway/utils v0.1.3
  go: downloading golang.helowin.com/go-gateway/utils v0.1.3
  go: extracting golang.helowin.com/go-gateway/utils v0.1.3
  golang.helowin.com/go-gateway/utils
```
进入`$GOPATH$`, 可以看到`$GOPATH$/src/golang.helowin.com/go-gateway/utils`已经存在.  
采用GO111MODULE(GOMOD)模式时可以在对应的mod目录下查看.  

### 导入
```go
package somepackage

import (
    "golang.helowin.com/chenzhongrun/utils/log"
)

func somefunc() {
	log.Infoln("success")
} 

``` 


