# 好络维Go语言开发 - 企业级包维护方法
内部包维护指的是, 开发过程中常用的代码和包, 应当组织起来, 提高复用程度.  
目前代码复用存在的问题, 主要在于常用包分散于各个具体的项目中, 不利于集中维护.  
如, 阅兵保障项目中开发的/utils包, 可以复用在b2c项目中, 
目前的做法是手动从阅兵保障项目中拷贝/utils包到b2c项目中.  
在两个项目分别开发过程中, 其中一个项目/utils包的修改, 不能同步到另一个项目中, 
当要维护的项目过多时, /utils包的不一致必定越来越多, 而且维护人员也难以区分哪个/utils包中的代码更新, 
哪个包中的代码更稳定, 哪个包中的代码更丰富更齐全了.  
所以将/utils这样的复用率较高的包单独拎出来维护是有必要的.  


有三种维护方案:  
* 第一种, 使用内网svn  
使用内网svn能一定程度上提高共同维护的效率, 但是我们的生产项目也是使用svn进行版本管理, 
当/utils包更新后, 还有单独用svn拉取下来, 放在生产项目的具体目录里.  

* 第二种, 使用外网github, gitlab等  
使用外网github, gitlab首先不符合公司保密要求, `go get`配置私有库也过于麻烦.  

* 第三中, 使用内网gitlab
一个gitlab平台已经搭建在http://192.168.1.195:8011, 可以进行代码管理.  
并且已经上传了一个示例项目http://192.168.1.195:8011/go-gateway/utils  
我们需要做的, 是令`go get`命令支持我们的内网平台.  
由于Go原生只支持github, gitlab, gitee等平台, 所以我们需要简单修改Go的源码,
以支持我们搭建的内网平台.  

## 快速开始
### Step-1 下载文件并替换
从以下列表下载对应版本的vcs.go文件,  
* 适用于go 1.12的 [vcs.go](http://192.168.1.195:8011/go-gateway/client-doc/uploads/35f499d18ec400f8d8f752628dce9217/vcs.go)  
* 适用于go 1.13的 [vcs.go](http://192.168.1.195:8011/go-gateway/client-doc/uploads/35454de7eaf9884b70c3fa26ff709799/vcs.go)  

将下载的文件替换掉本地的`$GOROOT$\src\cmd\go\internal\get\vcs.go`文件.  

### Step-2 重新编译安装
```cmd
$GOROOT$\src\cmd\go>> go install
```

### Step-3 设置环境变量
请设置:  
`CUSTOMVCSPREFIX`为`golang.helowin.com`  
`CUSTOMVCSADDRESS`为`192.168.1.195:8011`  
`GOPROXY`为`https://goproxy.io`  (用于go1.12以下版本) 或`https://goproxy.io,derect`  (仅作用与于go1.13以上版本)  
`GOPRIVATE`为`golang.helowin.com`  (仅作用与于go1.13以上版本)

### Step-4 使用`go get`
```cmd
>>export CUSTOMVCSPREFIX=golang.helowin.com # 如果设置了环境变量, 则不用输入此行
>>export CUSTOMVCSADDRESS=192.168.1.195:8011 # 如果设置了环境变量, 则不用输入此行
>>export GOPROXY=direct   # go1.13不需要设置此变量
>>go get -v -u -insecure golang.helowin.com/go-gateway/utils # -insecure表示不进行https检查, 以兼容我们的http服务器

  go: finding golang.helowin.com/go-gateway/utils v0.1.3
  go: downloading golang.helowin.com/go-gateway/utils v0.1.3
  go: extracting golang.helowin.com/go-gateway/utils v0.1.3
  golang.helowin.com/go-gateway/utils
```
完成, 成功从内网代码管理平台下载企业级包

### 注意:
* `go get`的 `-insecure` 参数一定要加, 不然go get会检查https服务器
* `go mod download`不支持`-insecure`, 无法使用此命令下载内网包  


## 下载列表
* 适用于go 1.12的 [vcs.go](http://192.168.1.195:8011/go-gateway/client-doc/uploads/35f499d18ec400f8d8f752628dce9217/vcs.go)  
* 适用于go 1.13的 [vcs.go](http://192.168.1.195:8011/go-gateway/client-doc/uploads/35454de7eaf9884b70c3fa26ff709799/vcs.go)

## 更多阅读
* [vcs.go修改细节](/workdoc/内部包维护方法2.md)  
* [企业包的维护](/workdoc/内部包维护方法3.md)

